# Import libraries
import pybinding as pb
import matplotlib.pyplot as plt
import numpy as np
from math import pi


# create a lattice in format of pyBinding
def GetLattice(onsite_energy=[2.47020691, -6.58218143, -10.05411924, -11.00605354, -6.22330291, 2.58577753, -1.74675496,
                              4.82956751, -7.35803158, -6.22330291, 2.58577753, -1.74675496, 4.82956751, -7.35803158]):
    lattice = pb.Lattice(
        a1=[2.73211807, -1.57738910, 0.00000000],
        a2=[0.00000000, 3.15477820, 0.00000000],
    )

    lattice.add_sublattices(
        # name and positions
        ('o1:Mo:1:s', [1.82141206, -0.00000002, 3.01448559], onsite_energy[0]),
        ('o2:Mo:1:p_y', [1.82141206, -0.00000002, 3.01448559], onsite_energy[1]),
        ('o3:Mo:1:p_z', [1.82141206, -0.00000002, 3.01448559], onsite_energy[2]),
        ('o4:Mo:1:p_x', [1.82141206, -0.00000002, 3.01448559], onsite_energy[3]),
        ('o5:S:1:d_{xy}', [0.91070601, 1.57738912, 1.44273907], onsite_energy[4]),
        ('o6:S:1:d_{yz}', [0.91070601, 1.57738912, 1.44273907], onsite_energy[5]),
        ('o7:S:1:d_{3z^2-r^2}', [0.91070601, 1.57738912, 1.44273907], onsite_energy[6]),
        ('o8:S:1:d_{xz}', [0.91070601, 1.57738912, 1.44273907], onsite_energy[7]),
        ('o9:S:1:d_{x^2-y^2}', [0.91070601, 1.57738912, 1.44273907], onsite_energy[8]),
        ('o10:S:1:d_{xy}', [0.91070601, 1.57738912, 4.58623211], onsite_energy[9]),
        ('o11:S:1:d_{yz}', [0.91070601, 1.57738912, 4.58623211], onsite_energy[10]),
        ('o12:S:1:d_{3z^2-r^2}', [0.91070601, 1.57738912, 4.58623211], onsite_energy[11]),
        ('o13:S:1:d_{xz}', [0.91070601, 1.57738912, 4.58623211], onsite_energy[12]),
        ('o14:S:1:d_{x^2-y^2}', [0.91070601, 1.57738912, 4.58623211], onsite_energy[13])
    )

    lattice.add_hoppings(

        # between main cell and the cell (1,1,0)

        # between main cell and the cell (1,0,0)
        ([1, 0, 0], 'o1:Mo:1:s', 'o7:S:1:d_{3z^2-r^2}', 0.06852366),
        ([1, 0, 0], 'o1:Mo:1:s', 'o8:S:1:d_{xz}', -0.41864039),
        ([1, 0, 0], 'o1:Mo:1:s', 'o9:S:1:d_{x^2-y^2}', 0.24256985),
        ([1, 0, 0], 'o1:Mo:1:s', 'o12:S:1:d_{3z^2-r^2}', 0.06852366),
        ([1, 0, 0], 'o1:Mo:1:s', 'o13:S:1:d_{xz}', 0.41864039),
        ([1, 0, 0], 'o1:Mo:1:s', 'o14:S:1:d_{x^2-y^2}', 0.24256985),
        ([1, 0, 0], 'o2:Mo:1:p_y', 'o5:S:1:d_{xy}', 1.33649864),
        ([1, 0, 0], 'o2:Mo:1:p_y', 'o6:S:1:d_{yz}', -1.15330143),
        ([1, 0, 0], 'o2:Mo:1:p_y', 'o10:S:1:d_{xy}', 1.33649864),
        ([1, 0, 0], 'o2:Mo:1:p_y', 'o11:S:1:d_{yz}', 1.15330143),
        ([1, 0, 0], 'o3:Mo:1:p_z', 'o7:S:1:d_{3z^2-r^2}', -0.92590920),
        ([1, 0, 0], 'o3:Mo:1:p_z', 'o8:S:1:d_{xz}', -1.14275994),
        ([1, 0, 0], 'o3:Mo:1:p_z', 'o9:S:1:d_{x^2-y^2}', 1.43653933),
        ([1, 0, 0], 'o3:Mo:1:p_z', 'o12:S:1:d_{3z^2-r^2}', 0.92590920),
        ([1, 0, 0], 'o3:Mo:1:p_z', 'o13:S:1:d_{xz}', -1.14275994),
        ([1, 0, 0], 'o3:Mo:1:p_z', 'o14:S:1:d_{x^2-y^2}', -1.43653933),
        ([1, 0, 0], 'o4:Mo:1:p_x', 'o7:S:1:d_{3z^2-r^2}', -1.24189746),
        ([1, 0, 0], 'o4:Mo:1:p_x', 'o8:S:1:d_{xz}', 1.71977723),
        ([1, 0, 0], 'o4:Mo:1:p_x', 'o9:S:1:d_{x^2-y^2}', -0.32822908),
        ([1, 0, 0], 'o4:Mo:1:p_x', 'o12:S:1:d_{3z^2-r^2}', -1.24189746),
        ([1, 0, 0], 'o4:Mo:1:p_x', 'o13:S:1:d_{xz}', -1.71977723),
        ([1, 0, 0], 'o4:Mo:1:p_x', 'o14:S:1:d_{x^2-y^2}', -0.32822908),

        # between main cell and the cell (1,-1,0)

        # between main cell and the cell (0,1,0)
        ([0, 1, 0], 'o5:S:1:d_{xy}', 'o1:Mo:1:s', 0.21007166),
        ([0, 1, 0], 'o5:S:1:d_{xy}', 'o2:Mo:1:p_y', 0.58029646),
        ([0, 1, 0], 'o5:S:1:d_{xy}', 'o3:Mo:1:p_z', 1.24407959),
        ([0, 1, 0], 'o5:S:1:d_{xy}', 'o4:Mo:1:p_x', -0.43659346),
        ([0, 1, 0], 'o6:S:1:d_{yz}', 'o1:Mo:1:s', 0.36255321),
        ([0, 1, 0], 'o6:S:1:d_{yz}', 'o2:Mo:1:p_y', 1.00150751),
        ([0, 1, 0], 'o6:S:1:d_{yz}', 'o3:Mo:1:p_z', 0.98965912),
        ([0, 1, 0], 'o6:S:1:d_{yz}', 'o4:Mo:1:p_x', 1.24407959),
        ([0, 1, 0], 'o7:S:1:d_{3z^2-r^2}', 'o1:Mo:1:s', 0.06852366),
        ([0, 1, 0], 'o7:S:1:d_{3z^2-r^2}', 'o2:Mo:1:p_y', 1.07551474),
        ([0, 1, 0], 'o7:S:1:d_{3z^2-r^2}', 'o3:Mo:1:p_z', -0.92590920),
        ([0, 1, 0], 'o7:S:1:d_{3z^2-r^2}', 'o4:Mo:1:p_x', 0.62094876),
        ([0, 1, 0], 'o8:S:1:d_{xz}', 'o1:Mo:1:s', 0.20932020),
        ([0, 1, 0], 'o8:S:1:d_{xz}', 'o2:Mo:1:p_y', 1.24407959),
        ([0, 1, 0], 'o8:S:1:d_{xz}', 'o3:Mo:1:p_z', 0.57137999),
        ([0, 1, 0], 'o8:S:1:d_{xz}', 'o4:Mo:1:p_x', -0.43503170),
        ([0, 1, 0], 'o9:S:1:d_{x^2-y^2}', 'o1:Mo:1:s', -0.12128491),
        ([0, 1, 0], 'o9:S:1:d_{x^2-y^2}', 'o2:Mo:1:p_y', 0.43659358),
        ([0, 1, 0], 'o9:S:1:d_{x^2-y^2}', 'o3:Mo:1:p_z', -0.71826960),
        ([0, 1, 0], 'o9:S:1:d_{x^2-y^2}', 'o4:Mo:1:p_x', -1.08443126),
        ([0, 1, 0], 'o10:S:1:d_{xy}', 'o1:Mo:1:s', 0.21007166),
        ([0, 1, 0], 'o10:S:1:d_{xy}', 'o2:Mo:1:p_y', 0.58029646),
        ([0, 1, 0], 'o10:S:1:d_{xy}', 'o3:Mo:1:p_z', -1.24407959),
        ([0, 1, 0], 'o10:S:1:d_{xy}', 'o4:Mo:1:p_x', -0.43659346),
        ([0, 1, 0], 'o11:S:1:d_{yz}', 'o1:Mo:1:s', -0.36255321),
        ([0, 1, 0], 'o11:S:1:d_{yz}', 'o2:Mo:1:p_y', -1.00150751),
        ([0, 1, 0], 'o11:S:1:d_{yz}', 'o3:Mo:1:p_z', 0.98965912),
        ([0, 1, 0], 'o11:S:1:d_{yz}', 'o4:Mo:1:p_x', -1.24407959),
        ([0, 1, 0], 'o12:S:1:d_{3z^2-r^2}', 'o1:Mo:1:s', 0.06852366),
        ([0, 1, 0], 'o12:S:1:d_{3z^2-r^2}', 'o2:Mo:1:p_y', 1.07551474),
        ([0, 1, 0], 'o12:S:1:d_{3z^2-r^2}', 'o3:Mo:1:p_z', 0.92590920),
        ([0, 1, 0], 'o12:S:1:d_{3z^2-r^2}', 'o4:Mo:1:p_x', 0.62094876),
        ([0, 1, 0], 'o13:S:1:d_{xz}', 'o1:Mo:1:s', -0.20932020),
        ([0, 1, 0], 'o13:S:1:d_{xz}', 'o2:Mo:1:p_y', -1.24407959),
        ([0, 1, 0], 'o13:S:1:d_{xz}', 'o3:Mo:1:p_z', 0.57137999),
        ([0, 1, 0], 'o13:S:1:d_{xz}', 'o4:Mo:1:p_x', 0.43503170),
        ([0, 1, 0], 'o14:S:1:d_{x^2-y^2}', 'o1:Mo:1:s', -0.12128491),
        ([0, 1, 0], 'o14:S:1:d_{x^2-y^2}', 'o2:Mo:1:p_y', 0.43659358),
        ([0, 1, 0], 'o14:S:1:d_{x^2-y^2}', 'o3:Mo:1:p_z', 0.71826960),
        ([0, 1, 0], 'o14:S:1:d_{x^2-y^2}', 'o4:Mo:1:p_x', -1.08443126),

        # inside the main cell
        ([0, 0, 0], 'o1:Mo:1:s', 'o5:S:1:d_{xy}', -0.21007166),
        ([0, 0, 0], 'o1:Mo:1:s', 'o6:S:1:d_{yz}', -0.36255321),
        ([0, 0, 0], 'o1:Mo:1:s', 'o7:S:1:d_{3z^2-r^2}', 0.06852364),
        ([0, 0, 0], 'o1:Mo:1:s', 'o8:S:1:d_{xz}', 0.20932019),
        ([0, 0, 0], 'o1:Mo:1:s', 'o9:S:1:d_{x^2-y^2}', -0.12128493),
        ([0, 0, 0], 'o1:Mo:1:s', 'o10:S:1:d_{xy}', -0.21007166),
        ([0, 0, 0], 'o1:Mo:1:s', 'o11:S:1:d_{yz}', 0.36255321),
        ([0, 0, 0], 'o1:Mo:1:s', 'o12:S:1:d_{3z^2-r^2}', 0.06852364),
        ([0, 0, 0], 'o1:Mo:1:s', 'o13:S:1:d_{xz}', -0.20932019),
        ([0, 0, 0], 'o1:Mo:1:s', 'o14:S:1:d_{x^2-y^2}', -0.12128493),
        ([0, 0, 0], 'o2:Mo:1:p_y', 'o5:S:1:d_{xy}', 0.58029652),
        ([0, 0, 0], 'o2:Mo:1:p_y', 'o6:S:1:d_{yz}', 1.00150761),
        ([0, 0, 0], 'o2:Mo:1:p_y', 'o7:S:1:d_{3z^2-r^2}', -1.07551469),
        ([0, 0, 0], 'o2:Mo:1:p_y', 'o8:S:1:d_{xz}', -1.24407957),
        ([0, 0, 0], 'o2:Mo:1:p_y', 'o9:S:1:d_{x^2-y^2}', -0.43659352),
        ([0, 0, 0], 'o2:Mo:1:p_y', 'o10:S:1:d_{xy}', 0.58029652),
        ([0, 0, 0], 'o2:Mo:1:p_y', 'o11:S:1:d_{yz}', -1.00150761),
        ([0, 0, 0], 'o2:Mo:1:p_y', 'o12:S:1:d_{3z^2-r^2}', -1.07551469),
        ([0, 0, 0], 'o2:Mo:1:p_y', 'o13:S:1:d_{xz}', 1.24407957),
        ([0, 0, 0], 'o2:Mo:1:p_y', 'o14:S:1:d_{x^2-y^2}', -0.43659352),
        ([0, 0, 0], 'o3:Mo:1:p_z', 'o5:S:1:d_{xy}', -1.24407957),
        ([0, 0, 0], 'o3:Mo:1:p_z', 'o6:S:1:d_{yz}', -0.98965906),
        ([0, 0, 0], 'o3:Mo:1:p_z', 'o7:S:1:d_{3z^2-r^2}', -0.92590927),
        ([0, 0, 0], 'o3:Mo:1:p_z', 'o8:S:1:d_{xz}', 0.57137993),
        ([0, 0, 0], 'o3:Mo:1:p_z', 'o9:S:1:d_{x^2-y^2}', -0.71826967),
        ([0, 0, 0], 'o3:Mo:1:p_z', 'o10:S:1:d_{xy}', 1.24407957),
        ([0, 0, 0], 'o3:Mo:1:p_z', 'o11:S:1:d_{yz}', -0.98965906),
        ([0, 0, 0], 'o3:Mo:1:p_z', 'o12:S:1:d_{3z^2-r^2}', 0.92590927),
        ([0, 0, 0], 'o3:Mo:1:p_z', 'o13:S:1:d_{xz}', 0.57137993),
        ([0, 0, 0], 'o3:Mo:1:p_z', 'o14:S:1:d_{x^2-y^2}', 0.71826967),
        ([0, 0, 0], 'o4:Mo:1:p_x', 'o5:S:1:d_{xy}', 0.43659350),
        ([0, 0, 0], 'o4:Mo:1:p_x', 'o6:S:1:d_{yz}', -1.24407957),
        ([0, 0, 0], 'o4:Mo:1:p_x', 'o7:S:1:d_{3z^2-r^2}', 0.62094870),
        ([0, 0, 0], 'o4:Mo:1:p_x', 'o8:S:1:d_{xz}', -0.43503173),
        ([0, 0, 0], 'o4:Mo:1:p_x', 'o9:S:1:d_{x^2-y^2}', -1.08443129),
        ([0, 0, 0], 'o4:Mo:1:p_x', 'o10:S:1:d_{xy}', 0.43659350),
        ([0, 0, 0], 'o4:Mo:1:p_x', 'o11:S:1:d_{yz}', 1.24407957),
        ([0, 0, 0], 'o4:Mo:1:p_x', 'o12:S:1:d_{3z^2-r^2}', 0.62094870),
        ([0, 0, 0], 'o4:Mo:1:p_x', 'o13:S:1:d_{xz}', 0.43503173),
        ([0, 0, 0], 'o4:Mo:1:p_x', 'o14:S:1:d_{x^2-y^2}', -1.08443129)
    )

    return lattice


# setup lattice with on-site potential terms
lat = GetLattice()
plt.figure()
plt.subplot(121)
plt.title('Lattice: xy')
lat.plot()

plt.subplot(122)
plt.title('Lattice: yz')
lat.plot(axes='yz')
plt.show()

# create a periodic model, which generates the Hamiltonian from the lattice
model = pb.Model(lat, pb.translational_symmetry())


b1, b2 = model.lattice.reciprocal_vectors()

P1 = b1[0:2] / 2.0
P2 = b2[0:2] / 2.0

Gamma = [0, 0]
K = [P1[0], P1[0]/3**0.5]
M = P1
# M = [2 * np.pi / (3 * 3 ** 0.5 * lat_acc), 2 * np.pi / (3 * lat_acc)]

path_list_1 = [r'$\Gamma$', 'M', 'K', r'$\Gamma$']
path_1 = pb.make_path(Gamma, M, K, Gamma, step=0.01)


bands_list = []
for k in path_1:
    model.set_wave_vector(k)
    solver = pb.solver.lapack(model)
    bands_list.append(solver.eigenvalues)

bands = pb.results.Bands(path_1, np.vstack(bands_list))
bands.plot(point_labels=path_list_1)
plt.ylim(-3, 4)
plt.axhline(y=0, linestyle='--', color='gray', linewidth=0.5)
plt.show()


model.lattice.plot_brillouin_zone()
bands.plot_kpath()
plt.show()